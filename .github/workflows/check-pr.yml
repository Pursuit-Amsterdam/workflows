name: Check and Validate PR branch

on:
  workflow_call:
    inputs:
      head-ref:
        description: "Head branch of the PR"
        required: true
        type: string
      base-ref:
        description: "Base branch of the PR"
        required: true
        type: string

jobs:
  pipeline:
    runs-on: blacksmith-4vcpu-ubuntu-2404

    steps:
      - uses: actions/checkout@v4

      - name: Check if merge is allowed
        shell: bash
        run: |
          HEAD="${{ inputs.head-ref }}"
          BASE="${{ inputs.base-ref }}"

          echo "HEAD: $HEAD"
          echo "BASE: $BASE"

          # 1. Validate branch naming
          if [[ 
            "$HEAD" != "main" &&
            "$HEAD" != "develop" &&
            "$HEAD" != "acceptance" &&
            "$HEAD" != hotfix/* &&
            "$HEAD" != feature/* &&
            "$HEAD" != release/* &&
            "$HEAD" != dependabot/* &&
            "$HEAD" != module/*/develop &&
            "$HEAD" != module/*/feature/*
          ]]; then
              echo "❌ Branch name '$HEAD' is not allowed."
              exit 1
          fi

          # 2. Merge rules

          # hotfix/*, release/*, develop → main
          if [[ "$BASE" == "main" ]]; then
            if [[ "$HEAD" == hotfix/* || "$HEAD" == release/* || "$HEAD" == "develop" ]]; then
              echo "✅ Merge allowed: $HEAD → main"
              exit 0
            else
              echo "❌ Merge not allowed: $HEAD → main"
              exit 1
            fi
          fi

          # feature/*, dependabot/*, module/*/develop, main → develop
          if [[ "$BASE" == "develop" ]]; then
            if [[ 
              "$HEAD" == feature/* ||
              "$HEAD" == dependabot/* ||
              "$HEAD" == module/*/develop ||
              "$HEAD" == "main"
            ]]; then
              echo "✅ Merge allowed: $HEAD → develop"
              exit 0
            else
              echo "❌ Merge not allowed: $HEAD → develop"
              exit 1
            fi
          fi

          # module/*/feature/* → module/*/develop
          if [[ "$BASE" == module/*/develop ]]; then
            if [[ "$HEAD" == module/*/feature/* ]]; then
              base_segment=$(echo "$BASE" | cut -d'/' -f2)
              head_segment=$(echo "$HEAD" | cut -d'/' -f2)

              if [[ "$base_segment" == "$head_segment" ]]; then
                echo "✅ Merge allowed: $HEAD → $BASE"
                exit 0
              fi
            fi

            echo "❌ Merge not allowed: $HEAD → $BASE"
            exit 1
          fi

          # develop → release/*
          if [[ "$BASE" == release/* ]]; then
            if [[ "$HEAD" == "develop" ]]; then
              echo "✅ Merge allowed: develop → $BASE"
              exit 0
            else
              echo "❌ Merge not allowed: $HEAD → $BASE"
              exit 1
            fi
          fi

          # develop → acceptance
          if [[ "$BASE" == "acceptance" ]]; then
            if [[ "$HEAD" == "develop" ]]; then
              echo "✅ Merge allowed: develop → acceptance"
              exit 0
            else
              echo "❌ Merge not allowed: $HEAD → acceptance"
              exit 1
            fi
          fi

          echo "❌ Merge not allowed: $HEAD → $BASE"
          exit 1
