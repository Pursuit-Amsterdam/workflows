name: 'Code Generation'

# This workflow runs code generation and handles different scenarios:
# 1. On PR: Checks if generated code is up-to-date, fails if not (unless auto-commit is enabled)
# 2. Manual dispatch: Can optionally auto-commit to PR branch or create new PR
# 3. Scheduled: Automatically creates PR with any updates
# 4. When schema/config files change: Triggers validation on PRs

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**/*.graphql'
      - '**/*.gql'
      - '**/schema.ts'
      - '**/schema.js'
      - '**/payload.config.ts'
      - '**/payload.config.js'
      - 'package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch:
    inputs:
      generate-types:
        description: 'Generate TypeScript types'
        required: false
        default: true
        type: boolean
      generate-graphql:
        description: 'Generate GraphQL code'
        required: false
        default: false
        type: boolean
      generate-payload:
        description: 'Generate PayloadCMS types'
        required: false
        default: false
        type: boolean
      custom-commands:
        description: 'Custom generation commands (space-separated)'
        required: false
        default: ''
        type: string
      onepassword-vault:
        description: '1Password vault name (required if using secrets)'
        required: false
        default: ''
        type: string
      onepassword-item:
        description: '1Password item name (required if using secrets)'
        required: false
        default: ''
        type: string
      auto-commit:
        description: 'Auto-commit changes to PR branch (only for manual runs)'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  codegen:
    name: 'Run Code Generation'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For PR events, checkout the PR branch with write permissions
          token: ${{ github.event_name == 'pull_request' && github.token || secrets.GITHUB_TOKEN }}
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}

      - name: Setup Node.js and PNPM
        uses: Pursuit-Amsterdam/.github/.github/actions/setup-node-pnpm
        with:
          node-version: '22.x'

      - name: Load 1Password Secrets (if needed)
        if: |
          (inputs.generate-graphql == true || inputs.generate-payload == true) &&
          inputs.onepassword-vault != '' && inputs.onepassword-item != ''
        uses: Pursuit-Amsterdam/.github/.github/actions/onepassword-secrets
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          vault-name: ${{ inputs.onepassword-vault }}
          item-name: ${{ inputs.onepassword-item }}
          export-for-vercel: 'false'

      - name: Run Code Generation
        uses: Pursuit-Amsterdam/.github/.github/actions/codegen
        with:
          generate-importmap: 'true'
          generate-types: ${{ inputs.generate-types || 'true' }}
          generate-graphql: ${{ inputs.generate-graphql || 'false' }}
          generate-payload: ${{ inputs.generate-payload || 'false' }}
          custom-commands: ${{ inputs.custom-commands || '' }}

      - name: Check for changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "üìù Generated code changes detected"
            git status --porcelain
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Generated code is up-to-date"
          fi

      - name: Commit changes to PR branch
        if: |
          steps.changes.outputs.changes == 'true' &&
          github.event_name == 'pull_request' &&
          (inputs.auto-commit == true || github.event_name == 'schedule')
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "chore: update generated code

          Auto-generated by GitHub Actions
          Run ID: ${{ github.run_id }}
          Triggered by: ${{ github.event_name }}"
          git push

      - name: Fail if changes needed (PR without auto-commit)
        if: |
          steps.changes.outputs.changes == 'true' &&
          github.event_name == 'pull_request' &&
          inputs.auto-commit != true &&
          github.event_name != 'schedule'
        run: |
          echo "‚ùå Generated code is outdated. Please run code generation and commit the changes."
          echo ""
          echo "You can either:"
          echo "1. Run 'pnpm generate' locally and commit the changes"
          echo "2. Re-run this workflow with 'auto-commit' enabled"
          echo "3. Manually trigger the workflow from the Actions tab"
          echo ""
          echo "Changed files:"
          git status --porcelain
          exit 1

      - name: Create Pull Request (for scheduled/manual runs)
        if: |
          steps.changes.outputs.changes == 'true' &&
          (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') &&
          github.event_name != 'pull_request'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update generated code'
          title: 'chore: update generated code'
          body: |
            ## Automated Code Generation
            
            This PR contains updates from automated code generation.
            
            Generated at: ${{ github.run_id }}
            Triggered by: ${{ github.event_name }}
            
            ### Changes
            - Updated generated types and code
            - Ran code generation pipeline
            
            Please review the changes and merge if everything looks correct.
          branch: 'automated/codegen-${{ github.run_number }}'
          delete-branch: true
          labels: |
            automated
            codegen
            dependencies