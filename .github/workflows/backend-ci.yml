name: "Backend CI (generic)"

on:
  workflow_call:
    inputs:
      platform:
        description: "Target deployment platform (supabase, ...)."
        required: true
        type: string
        default: "supabase"
      node-version:
        description: "Node.js version (if needed by actions)"
        required: false
        type: string
        default: "22.x"
      working-directory:
        description: "Working directory for the project"
        required: false
        type: string
        default: "."

      # 1Password secrets
      onepassword_enabled:
        description: "Enable 1Password secrets loading"
        required: false
        type: boolean
        default: false
      onepassword_vault:
        description: "1Password vault name"
        required: false
        type: string
        default: ""
      onepassword_item:
        description: "1Password item name"
        required: false
        type: string
        default: ""

    secrets:
      OP_SERVICE_ACCOUNT_TOKEN:
        required: false

jobs:
  supabase-ci:
    if: ${{ inputs.platform == 'supabase' }}
    runs-on: ubuntu-latest
    environment: 'integration'
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and PNPM
        uses: Pursuit-Amsterdam/workflows/.github/actions/setup-node-pnpm@main
        with:
          node-version: ${{ inputs.node-version }}
          node-auth-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup docker
        uses: docker/setup-buildx-action@v2

      - name: Load 1Password Secrets
        if: inputs.onepassword_enabled
        uses: Pursuit-Amsterdam/workflows/.github/actions/setup-onepassword@main
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          vault-name: ${{ inputs.onepassword_vault }}
          item-name: ${{ inputs.onepassword_item }}
          export-for-vercel: true

      - name: Setup local Supabase environment and test
        uses: Pursuit-Amsterdam/workflows/.github/actions/run-supabase-test@main
        with:
          seed: false

  unsupported-platform:
    if: ${{ inputs.platform != 'supabase' }}
    runs-on: ubuntu-latest
    steps:
      - name: Fail for unsupported platform
        run: |
          echo "Platform '${{ inputs.platform }}' is not supported by this workflow yet."
          echo "Supported platforms: supabase"
          exit 1
